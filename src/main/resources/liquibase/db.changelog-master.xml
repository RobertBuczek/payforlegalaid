<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.17.xsd">

  <changeSet author="liquibase-docs" id="dropTable-example">
      <preConditions onFail="MARK_RAN"><tableExists schemaName="GPFD" tableName="CSV_TO_SQL_MAPPING_TABLE"/></preConditions>
      <dropTable cascadeConstraints="true"
              schemaName="GPFD"
              tableName="CSV_TO_SQL_MAPPING_TABLE"/>
  </changeSet>

    <changeSet  id="1"  author="Liquibase User">
        <sql>
            CREATE SCHEMA GPFD;
        </sql>
    </changeSet>

    <changeSet id="2-create-csv-to-sql-mapping-table" author="robert_buczek">
        <createTable tableName="CSV_TO_SQL_MAPPING_TABLE" schemaName="GPFD">
            <column name="ID" type="CHAR (36)">
                <constraints nullable="true"/>
            </column>
            <column name="REPORT_NAME" type="VARCHAR(200)">
                <constraints nullable="true"/>
            </column>
            <column name="SQL_QUERY" type="VARCHAR(4000)">
                <constraints nullable="true"/>
            </column>
            <column name="BASE_URL" type="VARCHAR(450)">
                <constraints nullable="true"/>
            </column>
            <column name="REPORT_OWNER" type="VARCHAR(100)">
                <constraints nullable="true"/>
            </column>
            <column name="REPORT_CREATOR" type="VARCHAR(100)">
                <constraints nullable="true"/>
            </column>
            <column name="REPORT_DESCRIPTION" type="VARCHAR(400)">
                <constraints nullable="true"/>
            </column>
            <column name="EXCEL_REPORT" type="VARCHAR(200)">
                <constraints nullable="true"/>
            </column>
            <column name="EXCEL_SHEET_NUM" type="NUMBER">
                <constraints nullable="true"/>
            </column>
            <column name="CSV_NAME" type="VARCHAR(200)">
                <constraints nullable="true"/>
            </column>
            <column name="OWNER_EMAIL" type="VARCHAR(300)">
                <constraints nullable="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="3-create-report-tracking-table" author="robert_buczek">
        <createTable tableName="REPORT_TRACKING" schemaName="GPFD">
            <column name="ID" type="INTEGER">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="REPORT_NAME" type="VARCHAR(80)">
                <constraints nullable="false"/>
            </column>
            <column name="REPORT_URL" type="VARCHAR(500)">
                <constraints nullable="false"/>
            </column>
            <column name="CREATION_TIME" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="MAPPING_ID" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="REPORT_GENERATED_BY" type="VARCHAR(500)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="3-create-utils_pkg" author="robert_buczek">
        <sql dbms="oracle">
          CREATE OR REPLACE PACKAGE utils_pkg
          AS
            FUNCTION generate_uuid
            RETURN VARCHAR2;
          END utils_pkg;
        </sql>
        <sql dbms="h2">
            CREATE SCHEMA IF NOT EXISTS utils_pkg;
        </sql>
    </changeSet>

    <changeSet id="4-generate_uuid" author="robert_buczek">
        <sql dbms="oracle">
          CREATE OR REPLACE PACKAGE BODY utils_pkg
          AS
            FUNCTION generate_uuid
            RETURN VARCHAR2
            IS
              v_uuid VARCHAR2(36);
            BEGIN
              SELECT LOWER(REGEXP_REPLACE(RAWTOHEX(SYS_GUID()), '([A-F0-9]{8})([A-F0-9]{4})([A-F0-9]{4})([A-F0-9]{4})([A-F0-9]{12})', '\1-\2-\3-\4-\5'))
              INTO v_uuid
              FROM DUAL;

              RETURN v_uuid;
            END generate_uuid;
          END utils_pkg;
        </sql>
        <sql dbms="h2">
            CREATE ALIAS utils_pkg.generate_uuid FOR "java.util.UUID.randomUUID";
        </sql>
    </changeSet>

    <changeSet id="5-insert-data-csv-to-sql-mapping-table" author="robert_buczek">
        <sql>
            Insert into GPFD.CSV_TO_SQL_MAPPING_TABLE (ID,REPORT_NAME,SQL_QUERY,BASE_URL,REPORT_OWNER,REPORT_CREATOR,REPORT_DESCRIPTION,EXCEL_REPORT,EXCEL_SHEET_NUM,CSV_NAME,OWNER_EMAIL) values (utils_pkg.generate_uuid(), 'CCMS_invoice_analysis-CIS-to-CCMS-import-analysis-2','SELECT * FROM ANY_REPORT.V_CIS_TO_CCMS_INVOICE_SUMMARY',' https://justiceuk.sharepoint.com/:x:/r/sites/FinanceSysReference/Shared%20Documents/General/Monthly%20Accounts/Sharepoint%20base%20reports/General%20CCMS%20Tools/CCMS%20invoice%20analysis.xlsb?d=w7bc78b4b2c94489e899415353a37d234','Chancey Mctavish','Sophia Patel','Summary of invoices in CIS and CCMS by original source IT system','CCMS_invoice_analysis',2,'CIS-to-CCMS-import-analysis','owneremail@email.com');
        </sql>
    </changeSet>
</databaseChangeLog>